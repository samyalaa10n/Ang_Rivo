<div class="app-grid border border-1 rounded-1 ">
    <p-table #dt [rows]="ManyRowsInShow" [paginator]="paginator" columnResizeMode="expand" [dataKey]="dataKey"
        [scrollable]="true" [value]="dataSource" scrollDirection="both" [tableStyle]="tableStyle"
        [resizableColumns]="true" [expandedRowKeys]="expandedRows" responsiveLayout="stack" breakpoint="960px"
        [scrollHeight]="scrollHeight" [rowsPerPageOptions]="rowsPerPageOptions" tableStyleClass="p-datatable-gridlines"
        [globalFilterFields]="globalFilterFields" [showGridlines]="true" [reorderableColumns]="true"
        [(selection)]="selectedItems" (selectionChange)="onSelectAllChange($event)"
        (onRowUnselect)="onUnSelectRow($event);onGridAction({EVENT:$event,itemEdit:$event,ActonType:'UN_SELECT',COLUMN:null});"
        (onRowSelect)="onSelectRow($event);onGridAction({EVENT:$event,itemEdit:$event,ActonType:'SELECT',COLUMN:null})"
        [columns]="selectedColumns" [reorderableColumns]="true" [selectionMode]="selectionMode"
        [metaKeySelection]="singleSelectedMode" paginatorDropdownAppendTo="body">
        <ng-template #caption>
            <div *ngIf="AllowHeaderTemplate">
                <!-- Header Section -->
                <div class="caption-header">
                    <ng-content select="[header]"></ng-content>
                    <ng-content select="[btn]"></ng-content>
                </div>

                <!-- Search and Filter Section -->
                <div class="flex py-1 flex-wrap gap-2 search-section">
                    <p-iconfield *ngIf="AllowSearch" iconPosition="left" class="search-container">
                        <!-- Column Selector - Responsive -->
                        <app-multiselect class="d-inline-block mx-2 column-selector"
                            *ngIf="canSelectedSomeColumns && Columns.length>0" display="comma"
                            placeholder="Select Columns" [dataSource]="Columns" [(dataSelected)]="selectedColumns"
                            optionLabel="header" optionValue="name" selectedItemsLabel="{0} columns selected">
                        </app-multiselect>

                        <!-- Search Input -->
                        <div class="d-flex justify-content-center align-items-center  gap-1 search-input-group">
                            <input class="mx-1 form-control search-input" type="text" (input)="globalFilter(dt,$event)"
                                placeholder="Search" />
                            <p-button label="" [outlined]="true" icon="pi pi-filter-slash" (click)="clear(dt)"
                                [size]="'small'" />
                        </div>
                    </p-iconfield>
                </div>

                <!-- Body Content -->
                <ng-content select="[body]"></ng-content>

                <!-- Action Buttons Section -->
                <div class="my-2 action-buttons">
                    <!-- Expand/Collapse Row -->
                    <div class="button-row">
                        <p-button *ngIf="IsHasChild" [variant]="'text'" [raised]="true" label="Expand All"
                            icon="pi pi-plus" text [size]="'small'" (onClick)="expandAll()" />
                        <p-button *ngIf="IsHasChild" [variant]="'text'" [raised]="true" label="Collapse All"
                            icon="pi pi-minus" text [size]="'small'" (onClick)="collapseAll()" />
                    </div>

                    <!-- Main Actions Row -->
                    <div class="button-row">
                        <p-button *ngIf="AllowUpdate" [variant]="'text'" [raised]="true" [size]="'small'"
                            label="Refresh" severity="info" icon="pi pi-sync" (click)="onUpdate(dt)" />
                        <p-button *ngIf="AllowAdd" [variant]="'text'" [raised]="true" [size]="'small'" label="Add"
                            severity="success" icon="pi pi-plus" (click)="Add(dt)" />
                        <p-button *ngIf="AllowSave" [variant]="'text'" [raised]="true" [size]="'small'" severity="warn"
                            label="Save" icon="pi pi-save" (click)="save()">
                        </p-button>
                    </div>

                    <!-- Delete and Export Row -->
                    <div class="button-row">
                        <p-button *ngIf="AllowDeleteSelected" [variant]="'text'" [raised]="true" [size]="'small'"
                            severity="danger" label="Delete Selected" icon="pi pi-trash"
                            (click)="DeleteSelectedData()" />
                        <p-button *ngIf="AllowExportExcel" [variant]="'text'" [raised]="true" [size]="'small'"
                            label="Export" icon="pi pi-file-excel" (click)="exportExcel()" />
                    </div>

                    <!-- Import and Print Row -->
                    <div class="button-row">
                        <label *ngIf="AllowImportExcel" id="I_FILE" pButton [raised]="true" [size]="'small'">
                            <i class="pi pi-file-import" pButtonIcon></i>
                            <span pButtonLabel>Import</span>
                            <input hidden for="I_FILE" type="file" (change)="importExcel($event)">
                        </label>
                        <p-button severity="primary" [variant]="'text'" [raised]="true" [size]="'small'"
                            *ngIf="AllowPrint" label="Print" icon="pi pi-print" (click)="onPrint(dt)">
                        </p-button>
                    </div>

                    <!-- Additional Content -->
                    <ng-content select="[MORE_BUTTON]"></ng-content>

                    <!-- Copy/Paste Actions -->
                    <div class="copy-paste-actions">
                        <span *ngIf="AllowCopyPest" class="btn btn-sm p-2 copy-btn" pTooltip="Copy" (click)="Copy()">
                            <i class="pi pi-copy"></i>
                        </span>
                        <span *ngIf="AllowCopyPest" class="btn btn-sm p-2 paste-btn" pTooltip="Paste" (click)="Pest()">
                            <i class="pi pi-clipboard"></i>
                        </span>
                    </div>
                </div>
            </div>
        </ng-template>
        <ng-template #header let-columns>
            <tr>
                <th *ngIf="canReOrder" style="width: 6rem"></th>
                <th *ngIf="canSelectRow" style="width: 4rem ;text-align: center;"><p-tableHeaderCheckbox
                        *ngIf="!singleSelectedMode" /></th>
                <th *ngIf="IsHasChild" style="width: 5rem"></th>
                @for (column of columns; track $index) {
                <th *ngIf="column.InShow" class="text-center " pResizableColumn
                    [style]="'min-width:'+column.width+'px'">
                    <div class="d-flex justify-content-center align-items-center">
                        <div [pSortableColumn]="column.name" class="d-flex justify-content-center align-items-center ">
                            <div class="headerTr">{{ column.header }}</div>
                            <div><p-sortIcon [field]="column.name" /></div>
                        </div>
                        <div class="me-auto">
                            @if (column.filterType=='date') {
                            <p-columnFilter matchMode="contains" placeholder="Search" [type]="column.filterType"
                                display="menu" [field]="column.name" />
                            }
                            @else if(column.filterType=='comboBox') {
                            <p-columnFilter [field]="column.name" matchMode="in" display="menu" [showMatchModes]="false"
                                [showOperator]="false" [showAddButton]="false">
                                <ng-template #header>
                                    <div class="px-4 pt-4 pb-0">
                                        <span class="font-bold">Select</span>
                                    </div>
                                </ng-template>
                                <ng-template #filter let-value let-filter="filterCallback">
                                    <app-multiselect [style]="{'width': '250px'}" placeholder="Select"
                                        [dataSource]="column.columnComboBoxDataSource"
                                        (dataSelectedChange)="filter(editFilterMultiSelectValues($event,column.columnComboBoxOptionValue))"
                                        [optionLabel]="column.columnComboBoxOptionLabel"
                                        selectedItemsLabel="{0} columns selected"></app-multiselect>
                                </ng-template>
                            </p-columnFilter>
                            }
                            @else if(column.filterType!='none') {
                            <p-columnFilter display="menu" matchMode="contains" placeholder="Search"
                                [type]="column.filterType" [field]="column.name" />
                            }
                        </div>
                    </div>
                </th>
                }
                <th *ngIf="AllowCurdOperation" [ngClass]="isPine ? 'fixed-column' : 'Un-fixed-column'"
                    class="fixed-column px-2">
                    <div class="d-flex justify-content-center align-items-center">
                        <p-button [text]="!isPine" icon="pi pi-thumbtack" (onClick)="pinColumn()"></p-button>
                    </div>-
                </th>
            </tr>
        </ng-template>
        <ng-template #body let-item let-expanded="expanded" let-rowIndex="rowIndex" let-columns="columns">
            <tr #row [pSelectableRow]="item" [pSelectableRowDisabled]="!canSelectRow" [pSelectableRowIndex]="rowIndex"
                [pReorderableRow]="rowIndex">
                {{renderItems(item,row,rowIndex)}}
                <td *ngIf="canReOrder" class="text-center" style="min-width: 4rem;">
                    <span class="pi pi-bars" pReorderableRowHandle></span>
                </td>
                <td *ngIf="canSelectRow" class="text-center" style="min-width: 4rem;">
                    <p-tableCheckbox *ngIf="!singleSelectedMode" [value]="item" />
                    <p-tableRadioButton *ngIf="singleSelectedMode" [value]="item" />
                </td>
                <td *ngIf="IsHasChild " class="text-center" style="min-width: 4rem;">
                    <p-button *ngIf="item[dataKey]>0" type="button" (onClick)="expandedRow(item,rowIndex)" pRipple
                        [pRowToggler]="item" [text]="true" [rounded]="true" [plain]="true"
                        [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-left'" />
                </td>
                @for (column of columns; track $index)
                {
                <td class="text-center" *ngIf="column.InShow">
                    <label *ngIf="pageMode=='Mobile'">{{column.header}}:</label>
                    @switch (column.columnType) {
                    @case ("lapel") {
                    <ng-container *ngIf="item[column.name]!=null && item[column.name]!=undefined">
                        {{column.Style_Show(item[column.name],item ?? "")}}
                        {{column.DynamicShow(item) ?? ""}}
                    </ng-container>
                    <ng-container *ngIf="column.DynamicShow(item)!=''">
                        {{column.DynamicShow(item) ?? ""}}
                    </ng-container>
                    }
                    @case ("text") {
                    <input class="inputText" pInputText type="text" #text placeholder="Type..."
                        [(ngModel)]="item[column.name]" (keydown)="pInputTextKeyDown($event,text,item)"
                        (keyup)="onGridAction({EVENT:$event,itemEdit:item,ActonType:'KEYUP',COLUMN:column})" />
                    }
                    @case ("yes-no") {
                    <label for="ny" class="mx-2">{{column.header}}</label>
                    <p-checkbox id="ny" [(ngModel)]="item[column.name]"
                        (onChange)="onGridAction({EVENT:$event,itemEdit:item,ActonType:'KEYUP',COLUMN:column})"
                        [binary]="true" />
                    }
                    @case ("date") {
                    <app-DateTime placeholder="Type..." [(selectedDate)]="item[column.name]"
                        [maxDate]="column.columnMaxDate" [minDate]="column.columnMinDate"
                        (selectedDateChange)="onSelectColumnData(item,$event,column);onGridAction({EVENT:$event,itemEdit:item,ActonType:'KEYUP',COLUMN:column})"></app-DateTime>
                    }
                    @case ("date-Time") {
                    <app-DateTime placeholder="Type..." [(selectedDate)]="item[column.name]" [showTime]="true"
                        [maxDate]="column.columnMaxDate" [minDate]="column.columnMinDate"
                        (selectedDateChange)="onSelectColumnData(item,$event,column);onGridAction({EVENT:$event,itemEdit:item,ActonType:'KEYUP',COLUMN:column})"></app-DateTime>
                    }
                    @case ("Time") {
                    <app-DateTime placeholder="Type..." hourFormat="" [(selectedDate)]="item[column.name]"
                        [showTimeOnly]="true" [maxDate]="column.columnMaxDate" [minDate]="column.columnMinDate"
                        (selectedDateChange)="onSelectColumnData(item,$event,column);onGridAction({EVENT:$event,itemEdit:item,ActonType:'KEYUP',COLUMN:column})"></app-DateTime>
                    }
                    @case ("number") {
                    <p-inputnumber [(ngModel)]="item[column.name]"
                        (ngModelChange)="onGridAction({EVENT:$event,itemEdit:item,ActonType:'ngModelChange',COLUMN:column})"
                        (onKeyDown)="pInputTextKeyDown($event,{value:'1'},item)" mode="decimal" />
                    }
                    @case ("numberWithFraction") {
                    <p-inputnumber [(ngModel)]="item[column.name]" [minFractionDigits]="0" [maxFractionDigits]="3"
                        (ngModelChange)="onGridAction({EVENT:$event,itemEdit:item,ActonType:'ngModelChange',COLUMN:column})"
                        (onKeyDown)="pInputTextKeyDown($event,{value:'1'},item)" mode="decimal" />
                    }
                    @case ("comboBox") {
                    <app-comboBox #comboBox [dataSource]="column.columnComboBoxDataSource"
                        [optionValue]="column.columnComboBoxOptionValue" [apiPathDataSource]="column.apiPathDataSource"
                        [placeholder]="column.columnComboBoxPlaceholder"
                        [optionLabel]="column.columnComboBoxOptionLabel" [DefaultClearValue]="column.DefaultClearValue"
                        [refreshSource]="{func:column?.columnComboBoxRefreshSource?.func,item:item}"
                        (selectedChange)="column.columnComboBoxChange($event,item,comboBox);onGridAction({EVENT:$event,itemEdit:item,ActonType:'SELECT',COLUMN:column})"
                        [(SelectedValue)]="item[column.name]"></app-comboBox>
                    }
                    @case ("multiSelect") {
                    <app-multiselect #Multiselect [IsInGridMode]="true"
                        [dataSource]="column.columnMultiSelectDataSource" [placeholder]="column.columnMultiPlaceholder"
                        [optionLabel]="column.columnMultiOptionLabel"
                        (dataSelectedChange)="column.columnMultiSelectChange(Multiselect,item);onGridAction({EVENT:$event,itemEdit:item,ActonType:'SELECT',COLUMN:column})"
                        [item]="item" [idItemKey]="dataKey" [selectIdKey]="column.columnMultiSelectselectIdKey"
                        [optionValue]="column.columnMultiSelectOptionValue"
                        [propertyBind]="column.columnMultiSelectpropertyBind"></app-multiselect>

                    }
                    @case ("multiSelectObjectMode") {
                    <app-multiselect #Multiselect [dataSource]="column.columnMultiSelectDataSource"
                        [placeholder]="column.columnMultiPlaceholder" [optionLabel]="column.columnMultiOptionLabel"
                        [(dataSelected)]="item[column.name]" [idItemKey]="dataKey"
                        (dataSelectedChange)="column.columnMultiSelectChange(Multiselect,item);onGridAction({EVENT:$event,itemEdit:item,ActonType:'SELECT',COLUMN:column})"
                        [optionValue]="column.columnMultiSelectOptionValue"></app-multiselect>
                    }
                    @case ("textarea") {
                    <textarea [(ngModel)]="item[column.name]"
                        (keyup)="onGridAction({EVENT:$event,itemEdit:item,ActonType:'KEYUP',COLUMN:column})" pInputText
                        type="text" placeholder="Type..."></textarea>
                    }
                    @case ("custom") {
                    <ng-container [ngTemplateOutlet]="column.templateColumn"
                        [ngTemplateOutletContext]="{ $implicit:item ,Grid:this}"></ng-container>
                    }
                    }
                </td>
                }
                <td class="text-center px-4" [ngClass]="isPine ? 'fixed-column' : 'Un-fixed-column'"
                    *ngIf="AllowCurdOperation">
                    <span *ngIf="AllowCopyPestItems" pTooltip="Copy" class="btn  btn-sm p-2" (click)="CopyItem(item)">
                        <i class="pi pi-copy position-relative top-50"></i></span>
                    <span *ngIf="AllowCopyPestItems" pTooltip="Paste" class="btn  btn-sm p-2" (click)="PestItem(item)">
                        <i class="pi pi-clipboard position-relative top-50"></i></span>
                    <ng-container [ngTemplateOutlet]="templateBtn"
                        [ngTemplateOutletContext]="{ $implicit:item ,Grid:this}"></ng-container>
                    <p-button severity="danger" [variant]="'text'" [raised]="true" [size]="'small'" *ngIf="AllowDelete"
                        label="Delete" icon="pi pi-trash" (click)="onDeleteItem(item)"></p-button>
                    <p-button class="mx-2" severity="success" [variant]="'text'" [raised]="true" [size]="'small'"
                        *ngIf="AllowEdit" label="Edit" icon="pi pi-pen-to-square" (click)="EditItem(item)"></p-button>
                    <p-button class="mx-2 " severity="info" [variant]="'text'" [raised]="true" [size]="'small'"
                        *ngIf="AllowShow" label="View" icon="pi pi-eye" (click)="ShowItem(item)"></p-button>
                    <p-button class="mx-2" severity="success" [variant]="'text'" [raised]="true" [size]="'small'"
                        *ngIf="AddInherit" label="New" icon="pi pi-plus" (click)="AddInert(item)"></p-button>
                    <p-button class="mx-2" severity="primary" [variant]="'text'" [raised]="true" [size]="'small'"
                        *ngIf="AllowPrintItem" label="Print" icon="pi pi-print" (click)="onPrintItem(item)"></p-button>
                </td>
            </tr>
        </ng-template>
        <ng-template #expandedrow let-item *ngIf="IsHasChild">
            <tr>
                <th [colSpan]="colSpan" class="p-1 border border-1 bg-light">
                    <app-dataGrid #childGrid [ParentGrid]="this" [RowParent]="item"></app-dataGrid>
                </th>
            </tr>
        </ng-template>
    </p-table>
    <ng-content select="[footer]"></ng-content>
</div>

<p-dialog [header]="_eventEffect" [(visible)]="_showModel" [modal]="true" [style]="{'min-width':'80%'}"
    (onHide)="HideModel()">
    @for (column of Columns; track $index) {
    <div class="my-4">
        @switch (column.columnTypeModelMode) {
        @case ("lapel") {
        <label class="d-block">{{column.header}}:</label>
        <ng-container *ngIf="_selectedItem[column.name]!=null && _selectedItem[column.name]!=undefined">
            {{column.Style_ShowModelMode(_selectedItem[column.name])}}
            {{column.DynamicShowModelMode(_selectedItem)}}
        </ng-container>
        <ng-container *ngIf="column.Style_ShowModelMode(_selectedItem)!=''">
            {{column.DynamicShowModelMode(_selectedItem)}}
        </ng-container>
        }
        @case ("text") {
        <label class="d-block">{{column.header}}:</label>
        <input class="inputText form-control form-input" pInputText type="text" #text placeholder="Type..."
            [(ngModel)]="_selectedItem[column.name]" (keydown)="pInputTextKeyDown($event,text,_selectedItem)"
            (keyup)="onGridAction({EVENT:$event,itemEdit:_selectedItem,ActonType:'KEYUP',COLUMN:column})" />
        }
        @case ("yes-no") {
        <label class="d-block">{{column.header}}:</label>
        <p-checkbox id="ny" [(ngModel)]="_selectedItem[column.name]"
            (onChange)="onGridAction({EVENT:$event,itemEdit:_selectedItem,ActonType:'KEYUP',COLUMN:column})"
            [binary]="true" />
        }
        @case ("date") {
        <label class="d-block">{{column.header}}:</label>
        <app-DateTime class="d-inline-block my-3 w-100" placeholder="Type..."
            [(selectedDate)]="_selectedItem[column.name]" [maxDate]="column.columnMaxDate"
            [minDate]="column.columnMinDate"
            (selectedDateChange)="onSelectColumnData(_selectedItem,$event,column);onGridAction({EVENT:$event,itemEdit:_selectedItem,ActonType:'KEYUP',COLUMN:column})"></app-DateTime>
        }
        @case ("date-Time") {
        <label class="d-block">{{column.header}}:</label>
        <app-DateTime class="d-inline-block my-3 " placeholder="Type..." [(selectedDate)]="_selectedItem[column.name]"
            [showTime]="true" [maxDate]="column.columnMaxDate" [minDate]="column.columnMinDate"
            (selectedDateChange)="onSelectColumnData(_selectedItem,$event,column);onGridAction({EVENT:$event,itemEdit:_selectedItem,ActonType:'KEYUP',COLUMN:column})"></app-DateTime>
        }
        @case ("Time") {
        <label class="d-block">{{column.header}}:</label>
        <app-DateTime class="d-inline-block my-3" placeholder="Type..." hourFormat=""
            [(selectedDate)]="_selectedItem[column.name]" [showTimeOnly]="true" [maxDate]="column.columnMaxDate"
            [minDate]="column.columnMinDate"
            (selectedDateChange)="onSelectColumnData(_selectedItem,$event,column);onGridAction({EVENT:$event,itemEdit:_selectedItem,ActonType:'KEYUP',COLUMN:column})"></app-DateTime>
        }
        @case ("number") {
        <label class="d-block">{{column.header}}:</label>
        <p-inputnumber class="d-block my-3 w-100" [(ngModel)]="_selectedItem[column.name]" placeholder="Type..."
            (ngModelChange)="onGridAction({EVENT:$event,itemEdit:_selectedItem,ActonType:'ngModelChange',COLUMN:column})"
            (onKeyDown)="pInputTextKeyDown($event,{value:'1'},_selectedItem)" mode="decimal" />
        }
        @case ("numberWithFraction") {
        <label class="d-block">{{column.header}}:</label>
        <p-inputnumber class="d-block my-3 w-100" [(ngModel)]="_selectedItem[column.name]" placeholder="Type..."
            [minFractionDigits]="0" [maxFractionDigits]="3"
            (ngModelChange)="onGridAction({EVENT:$event,itemEdit:_selectedItem,ActonType:'ngModelChange',COLUMN:column})"
            (onKeyDown)="pInputTextKeyDown($event,{value:'1'},_selectedItem)" mode="decimal" />
        }
        @case ("comboBox") {
        <app-comboBox class="d-block my-3 w-100" #comboBox [dataSource]="column.columnComboBoxDataSource"
            [optionValue]="column.columnComboBoxOptionValue" [apiPathDataSource]="column.apiPathDataSource"
            [placeholder]="column.header" [optionLabel]="column.columnComboBoxOptionLabel"
            [refreshSource]="{func:column?.columnComboBoxRefreshSource?.func,item:_selectedItem}"
            (selectedChange)="column.columnComboBoxChange($event,_selectedItem,comboBox);onGridAction({EVENT:$event,itemEdit:_selectedItem,ActonType:'SELECT',COLUMN:column})"
            [(SelectedValue)]="_selectedItem[column.name]"></app-comboBox>
        }
        @case ("multiSelect") {
        <app-multiselect class="d-block my-3 w-100" #Multiselect [IsInGridMode]="true"
            [dataSource]="column.columnMultiSelectDataSource" [placeholder]="column.header"
            [optionLabel]="column.columnMultiOptionLabel"
            (dataSelectedChange)="column.columnMultiSelectChange(Multiselect,_selectedItem);onGridAction({EVENT:$event,itemEdit:_selectedItem,ActonType:'SELECT',COLUMN:column})"
            [item]="_selectedItem" [idItemKey]="dataKey" [selectIdKey]="column.columnMultiSelectselectIdKey"
            [optionValue]="column.columnMultiSelectOptionValue"
            [propertyBind]="column.columnMultiSelectpropertyBind"></app-multiselect>

        }
        @case ("multiSelectObjectMode") {
        <app-multiselect class="d-block my-3 w-100" #Multiselect [dataSource]="column.columnMultiSelectDataSource"
            [placeholder]="column.header" [optionLabel]="column.columnMultiOptionLabel"
            [(dataSelected)]="_selectedItem[column.name]" [idItemKey]="dataKey"
            (dataSelectedChange)="column.columnMultiSelectChange(Multiselect,_selectedItem);onGridAction({EVENT:$event,itemEdit:_selectedItem,ActonType:'SELECT',COLUMN:column})"
            [optionValue]="column.columnMultiSelectOptionValue"></app-multiselect>
        }
        @case ("textarea") {
        <label class="d-block">{{column.header}}:</label>
        <textarea class="d-block  w-100" [(ngModel)]="_selectedItem[column.name]"
            (keyup)="onGridAction({EVENT:$event,itemEdit:_selectedItem,ActonType:'KEYUP',COLUMN:column})" pInputText
            type="text" placeholder="Type..."></textarea>
        }
        @case ("custom") {
        <ng-container [ngTemplateOutlet]="column.templateColumn"
            [ngTemplateOutletContext]="{ $implicit:_selectedItem ,Grid:this}"></ng-container>
        }
        }
    </div>

    }
    <div class="d-flex justify-center align-items-center">
        <p-button *ngIf="AllowSave" [variant]="'text'" [raised]="true" [size]="'small'" severity="warn" label="Save"
            icon="pi pi-save" (click)="saveTempAdd()"></p-button>
    </div>
</p-dialog>